{{- $fullname := include "kafka.fullname" . -}}
{{- $name := include "kafka.name" . -}}
{{- $chart := include "kafka.chart" . -}}
{{- $root := . }}
*** Use Kafka from a container running on the host ***

{{ range .Values.nodes }}
Select Kafka broker {{ .id }} by running these commands:

  export KAFKA_PORT=$(kubectl -n {{ $root.Release.Namespace | default "default" }} get services -l server=kafka-{{ .id }},external=true -o jsonpath="{.items[0].spec.ports[0].nodePort}")
  export NODE_IP=$(kubectl -n {{ $root.Release.Namespace | default "default" }} get nodes -l zone={{ .zone }} -o jsonpath="{.items[0].status.addresses[0].address}")

List topics running this command:

  docker run --rm -it {{ $root.Values.image.registry }}{{ $root.Values.image.repository }}:{{ $root.Values.image.tag }} kafka-topics --list --bootstrap-server $NODE_IP:$KAFKA_PORT

Produce messages into topic by running this command:

  docker run --rm -it {{ $root.Values.image.registry }}{{ $root.Values.image.repository }}:{{ $root.Values.image.tag }} kafka-console-producer --broker-list $NODE_IP:$KAFKA_PORT --topic test

Consume messages from topic by running this command:

  docker run --rm -it {{ $root.Values.image.registry }}{{ $root.Values.image.repository }}:{{ $root.Values.image.tag }} kafka-console-consumer --bootstrap-server $NODE_IP:$KAFKA_PORT --topic test --from-beginning
{{ end }}


*** Use Kafka from a pod running on the cluster ***

List topics by running this command:

  kubectl -n {{ $root.Release.Namespace | default "default" }} run test --rm -it --restart=Never --image={{ $root.Values.image.registry }}{{ $root.Values.image.repository }}:{{ $root.Values.image.tag }} -- kafka-topics --list --bootstrap-server {{ $name }}-headless:9092

Produce messages into a topic by running this command:

  kubectl -n {{ $root.Release.Namespace | default "default" }} run test --rm -it --restart=Never --image={{ $root.Values.image.registry }}{{ $root.Values.image.repository }}:{{ $root.Values.image.tag }} -- kafka-console-producer --broker-list {{ $name }}-headless:9092 --topic test

Consume messages from a topic by running this command:

  kubectl -n {{ $root.Release.Namespace | default "default" }} run test --rm -it --restart=Never --image={{ $root.Values.image.registry }}{{ $root.Values.image.repository }}:{{ $root.Values.image.tag }} -- kafka-console-consumer --bootstrap-server {{ $name }}-headless:9092 --topic test --from-beginning


*** Retrieve logs from the brokers ***

Tail logs of Kafka brokers by running this command:

  kubectl -n {{ $root.Release.Namespace | default "default" }} logs -f -l app={{ $name }}

{{ range .Values.nodes }}
Tail logs of Kafka broker {{ .id }} by running this command:

  kubectl -n {{ $root.Release.Namespace | default "default" }} logs -f -l server={{ $name }}-{{ .id }} 
{{ end }}
